<!DOCTYPE html>
<html lang="en">
  <meta charset="utf-8">
  <title>Go JSONPath Playground</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="stylesheet" href="play.css">
  <script src="wasm_exec.js"></script>
  <script>
    document.addEventListener('DOMContentLoaded', function () {
      const $ = (id) => document.getElementById(id);
      const $$ = (q) => document.querySelector(q);

      const optionNames = [
        //"optLocated",
      ];

      const EXAMPLE_JSON = {
        "store": {
          "book": [
            {
              "category": "reference",
              "author": "Nigel Rees",
              "title": "Sayings of the Century",
              "price": 8.95
            },
            {
              "category": "fiction",
              "author": "Evelyn Waugh",
              "title": "Sword of Honour",
              "price": 12.99
            },
            {
              "category": "fiction",
              "author": "Herman Melville",
              "title": "Moby Dick",
              "isbn": "0-553-21311-3",
              "price": 8.99
            },
            {
              "category": "fiction",
              "author": "J. R. R. Tolkien",
              "title": "The Lord of the Rings",
              "isbn": "0-395-19395-8",
              "price": 22.99
            }
          ],
          "bicycle": {
            "color": "red",
            "price": 399
          }
        }
      }

      const QUERY_EXAMPLES = [
        "$.store.book[?@.author == 'Herman Melville']['title', 'author', 'price']",
        "$.store.book[?search(@.author, 'Waugh|Tolkien')]",
        "$.store.book[?@.price < 20 && @.price > 10]",
        "$..book[?@.price < 20].title",
        "$..book[?@.category == 'reference'].*",
        "$.store.book[::-1]",
        "$..author",
        "$..price",
      ];

      const getQueryExample = () => QUERY_EXAMPLES[Math.floor(Math.random() * QUERY_EXAMPLES.length)];

      const getOptions = function () {
        let options = 0;
        for (const optionName of optionNames) {
          if (document.getElementById(optionName).checked) {
            options |= window[optionName];
          }
        }
        return options;
      };

      const setOptions = function (value) {
        value = !value ? 0 : parseInt(value);
        for (const optionName of optionNames) {
          document.getElementById(optionName).checked =
            (window[optionName] & value) === window[optionName];
        }
      };

      const execute = function () {
        const options = getOptions();
        const outputElm = $$('#values');
        outputElm.value = query($('path').value, $('json').value, options);
        fit(outputElm);
      }

      const execPermalink = function () {
        const u = new URL(location.href);
        u.searchParams.set("p", encodeURIComponent($('path').value));
        u.searchParams.set("j", encodeURIComponent($('json').value));
        u.searchParams.set("o", getOptions());
        window.location = u.href;
      }

      const fit = function (elem) {
        elem.style.height = "";
        elem.style.height = elem.scrollHeight + 3 + "px"
      }

      const go = new Go();
      // https://github.com/tinygo-org/tinygo/issues/1140#issuecomment-1783897193
      go.importObject.gojs["syscall/js.finalizeRef"] = _ => 0;
      const WASM_URL = './play.wasm';

      var wasm;
      const onload = function (obj) {
        wasm = obj.instance;
        go.run(wasm);

        const u = new URL(location.href);
        if (u.searchParams.has("o")) {
          setOptions(u.searchParams.get("o"));
        }
        $("path").value = u.searchParams.has("p")
          ? decodeURIComponent(u.searchParams.get("p"))
          : getQueryExample();

        const json = $("json");
        json.value = u.searchParams.has("j")
          ? decodeURIComponent(u.searchParams.get("j"))
          : JSON.stringify(EXAMPLE_JSON, null, 2);
        fit(json);
      };

      if ('instantiateStreaming' in WebAssembly) {
        WebAssembly.instantiateStreaming(fetch(WASM_URL), go.importObject).then(onload);
      } else {
        fetch(WASM_URL).then(resp =>
          resp.arrayBuffer()
        ).then(bytes => WebAssembly.instantiate(bytes, go.importObject).then(onload));
      }

      $('exec-btn').addEventListener('click', _ => { execute() });
      $('permalink').addEventListener('click', _ => { execPermalink() });
      $('json').addEventListener('input', event => { fit(event.target) });
      $('values').addEventListener('input', event => { fit(event.target) });
      $('btn-info').addEventListener('click', _ => { const d = $('about'); d.open = !d.open });
      $('btn-help').addEventListener('click', _ => { const d = $('help'); d.open = !d.open });
    });
  </script>
</head>

<body>
  <header>
    <h1>Go JSONPath Playground</h1>
    <div>
      <button type="button" id="btn-help" title="JSONPath expression cheat sheet">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="fill:currentcolor;"><path d="M12 6a3.939 3.939 0 0 0-3.934 3.934h2C10.066 8.867 10.934 8 12 8s1.934.867 1.934 1.934c0 .598-.481 1.032-1.216 1.626a9.208 9.208 0 0 0-.691.599c-.998.997-1.027 2.056-1.027 2.174V15h2l-.001-.633c.001-.016.033-.386.441-.793.15-.15.339-.3.535-.458.779-.631 1.958-1.584 1.958-3.182A3.937 3.937 0 0 0 12 6zm-1 10h2v2h-2z"></path><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path></svg>
      </button>
      <button type="button" id="btn-info" title="About the Go JSONPath Playground">
        <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" style="fill:currentcolor;"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm0 18c-4.411 0-8-3.589-8-8s3.589-8 8-8 8 3.589 8 8-3.589 8-8 8z"></path><path d="M11 11h2v6h-2zm0-4h2v2h-2z"></path></svg>
      </button>
    </div>
  </header>
  <details id="about">
    <summary>About</summary>
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill:currentcolor; "><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm1 15h-2v-6h2v6zm0-8h-2V7h2v2z"></path></svg>
      About
    </h2>
    <p>This is the playground for {{version}} of <strong>github.com/theory/jsonpath</strong>, a Go package that executes an <a
        href="https://www.rfc-editor.org/rfc/rfc9535.html">RFC 9535 JSONPath</a> query to select values from JSON data.</p>
    <p>The playground runs entirely in the browser thanks to <a href="https://tinygo.org"
        title="TinyGo ‚Äî A Go Compiler For Small Places">TinyGo</a>, which compiles the
      <strong>github.com/theory/jsonpath</strong> package into Web Assembly.</p>
    <p>Learn more about JSONPath by reading the <a href="https://www.rfc-editor.org/rfc/rfc9535.html">IETF JSONPath
        Standard</a>, and more about <strong>github.com/theory/jsonpath</strong> by following the links at the bottom of
      the page. The code for this website can be found <a href="https://github.com/theory/jsonpath/tree/playground">on
        GitHub</a>.</p>
    <h3>Related Playgrounds:</h3>
    <ul>
      <li>üå≥ <a href="https://theory.github.io/jsontree/">JSONTree Playground</a></li>
      <li>üêò <a href="https://theory.github.io/sqljson/">SQL/JSON Path Playground</a></li>
    </ul>
  </details>
  <details id="help">
    <summary>JSONPath Expressions</summary>
    <h2>
      <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill:currentcolor;"><path d="M12 2C6.486 2 2 6.486 2 12s4.486 10 10 10 10-4.486 10-10S17.514 2 12 2zm1 16h-2v-2h2v2zm.976-4.885c-.196.158-.385.309-.535.459-.408.407-.44.777-.441.793v.133h-2v-.167c0-.118.029-1.177 1.026-2.174.195-.195.437-.393.691-.599.734-.595 1.216-1.029 1.216-1.627a1.934 1.934 0 0 0-3.867.001h-2C8.066 7.765 9.831 6 12 6s3.934 1.765 3.934 3.934c0 1.597-1.179 2.55-1.958 3.181z"></path></svg>
      JSONPath Expressions
    </h2>
    <table>
      <thead>
        <tr>
          <th>Syntax Element</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td><code>$</code></td>
          <td>root node identifier</td>
        </tr>
        <tr>
          <td><code>@</code></td>
          <td>current node identifier (valid only within filter selectors)</td>
        </tr>
        <tr>
          <td><code>[&lt;selectors&gt;]</code></td>
          <td>child segment: selects zero or more children of a node</td>
        </tr>
        <tr>
          <td><code>.name</code></td>
          <td>shorthand for <code>['name']</code></td>
        </tr>
        <tr>
          <td><code>.*</code></td>
          <td>shorthand for <code>[*]</code></td>
        </tr>
        <tr>
          <td><code>..[&lt;selectors&gt;]</code></td>
          <td>descendant segment: selects zero or more descendants of a node</td>
        </tr>
        <tr>
          <td><code>..name</code></td>
          <td>shorthand for <code>..['name']</code></td>
        </tr>
        <tr>
          <td><code>..*</code></td>
          <td>shorthand for <code>..[*]</code></td>
        </tr>
        <tr>
          <td><code>'name'</code> or <code>"name"</code></td>
          <td>name selector: selects a named child of an object</td>
        </tr>
        <tr>
          <td><code>*</code></td>
          <td>wildcard selector: selects all children of a node</td>
        </tr>
        <tr>
          <td><code>3</code></td>
          <td>index selector: selects an indexed child of an array (from 0)</td>
        </tr>
        <tr>
          <td><code>0:100:5</code></td>
          <td>array slice selector: <code>start:end:step</code> for arrays</td>
        </tr>
        <tr>
          <td><code>?&lt;logical-expr&gt;</code></td>
          <td>filter selector: selects particular children using a logical expression</td>
        </tr>
        <tr>
          <td><code>length(@.foo)</code></td>
          <td>function extension: invokes a function in a filter expression</td>
        </tr>
      </tbody>
    </table>
  </details>
  <noscript>
    <div class="warn">
      <h2>
        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" style="fill:currentcolor;"><path d="M16.707 2.293A.996.996 0 0 0 16 2H8a.996.996 0 0 0-.707.293l-5 5A.996.996 0 0 0 2 8v8c0 .266.105.52.293.707l5 5A.996.996 0 0 0 8 22h8c.266 0 .52-.105.707-.293l5-5A.996.996 0 0 0 22 16V8a.996.996 0 0 0-.293-.707l-5-5zM13 17h-2v-2h2v2zm0-4h-2V7h2v6z"></path></svg>
        This app requires JavaScript
      </h2>
      <p>The Go JSONPath Playground is a stateless single-page site written in
      JavaScript. It therefore requires JavaScript to be enabled in the
      browser.</p>
      <p>No data is stored except in the Permalink URL.</p>
    </div>
  </noscript>
  <div id="fluid">
    <input id="path" placeholder="Enter a JSONPath query‚Ä¶">
    <div id="go">
      <button id="exec-btn">Run Query</button>
      <button id="permalink"
        title="Reload with a permanent link that populates all the fields and executes the path">Permalink</button>
    </div>
  </div>
  <div id="container">
    <div id="input">
      <label title="The JSON against which to execute the Path expression">JSON Input
        <textarea id="json"></textarea>
      </label>
    </div>
    <div id="output">
      <!--
      <label for="optLocated" class="opt" title="Show the normalized path location of each value">
        <input id="optLocated" type="checkbox">
        Located
      </label>
      -->
      <label for="values" title="The values selected from the JSON Input">Query Output
        <textarea id="values" readonly>[]</textarea>
      </label>
    </div>
  </div>
  <footer>
    <p>Queries powered by the Go <strong>github.com/theory/jsonpath</strong> package:</p>
    <div id="refs">
      <a href="https://github.com/theory/jsonpath" title="GitHub Repository">
        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 16 16" color="#adb5bd"
          style="color: rgb(173, 181, 189);" height="24" width="24" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M8 0C3.58 0 0 3.58 0 8c0 3.54 2.29 6.53 5.47 7.59.4.07.55-.17.55-.38 0-.19-.01-.82-.01-1.49-2.01.37-2.53-.49-2.69-.94-.09-.23-.48-.94-.82-1.13-.28-.15-.68-.52-.01-.53.63-.01 1.08.58 1.23.82.72 1.21 1.87.87 2.33.66.07-.52.28-.87.51-1.07-1.78-.2-3.64-.89-3.64-3.95 0-.87.31-1.59.82-2.15-.08-.2-.36-1.02.08-2.12 0 0 .67-.21 2.2.82.64-.18 1.32-.27 2-.27.68 0 1.36.09 2 .27 1.53-1.04 2.2-.82 2.2-.82.44 1.1.16 1.92.08 2.12.51.56.82 1.27.82 2.15 0 3.07-1.87 3.75-3.65 3.95.29.25.54.73.54 1.48 0 1.07-.01 1.93-.01 2.2 0 .21.15.46.55.38A8.012 8.012 0 0 0 16 8c0-4.42-3.58-8-8-8z">
          </path>
        </svg>
      </a>
      <a href="https://github.com/theory/jsonpath/blob/main/README.md" title="Documentation">
        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" color="#adb5bd"
          style="color: rgb(173, 181, 189);" height="26" width="26" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M21 3h-7a2.98 2.98 0 0 0-2 .78A2.98 2.98 0 0 0 10 3H3a1 1 0 0 0-1 1v15a1 1 0 0 0 1 1h5.758c.526 0 1.042.214 1.414.586l1.121 1.121c.009.009.021.012.03.021.086.079.182.149.294.196h.002a.996.996 0 0 0 .762 0h.002c.112-.047.208-.117.294-.196.009-.009.021-.012.03-.021l1.121-1.121A2.015 2.015 0 0 1 15.242 20H21a1 1 0 0 0 1-1V4a1 1 0 0 0-1-1zM8.758 18H4V5h6c.552 0 1 .449 1 1v12.689A4.032 4.032 0 0 0 8.758 18zM20 18h-4.758c-.799 0-1.584.246-2.242.689V6c0-.551.448-1 1-1h6v13z">
          </path>
        </svg>
      </a>
      <a href="https://pkg.go.dev/github.com/theory/jsonpath" title="Go Package">
        <svg stroke="currentColor" fill="currentColor" stroke-width="0" viewBox="0 0 24 24" color="#adb5bd"
          style="color: rgb(173, 181, 189);" height="26" width="26" xmlns="http://www.w3.org/2000/svg">
          <path
            d="M22 8a.76.76 0 0 0 0-.21v-.08a.77.77 0 0 0-.07-.16.35.35 0 0 0-.05-.08l-.1-.13-.08-.06-.12-.09-9-5a1 1 0 0 0-1 0l-9 5-.09.07-.11.08a.41.41 0 0 0-.07.11.39.39 0 0 0-.08.1.59.59 0 0 0-.06.14.3.3 0 0 0 0 .1A.76.76 0 0 0 2 8v8a1 1 0 0 0 .52.87l9 5a.75.75 0 0 0 .13.06h.1a1.06 1.06 0 0 0 .5 0h.1l.14-.06 9-5A1 1 0 0 0 22 16V8zm-10 3.87L5.06 8l2.76-1.52 6.83 3.9zm0-7.72L18.94 8 16.7 9.25 9.87 5.34zM4 9.7l7 3.92v5.68l-7-3.89zm9 9.6v-5.68l3-1.68V15l2-1v-3.18l2-1.11v5.7z">
          </path>
        </svg>
      </a>
    </div>
  </footer>
</body>

</html>
